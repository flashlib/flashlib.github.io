---
layout: post_page
title: 难以定位的bug往往都很容易解决
---

在我的编程生涯中，经常遇到一些难以定们的bug，定位时间少则一天，多则数日，甚至更久。而当这些bug的原因浮出水面时，往往都是简单的问题导致的，最典型的莫过于“拼写错误”！大部分bug的解决方案往往都很简单，这个比例应该比2-8原则还要高，也就是超过80%bug的解决方案都是很简单的。

下面是我近期解决的两个bug，其中一个来源于生活，另一个来源于iOS程序开发，虽然两个问题来自不同领域，但是却同时印证了我上面的说法。

###案例一：洗上热水澡不再是梦###
几年前我租了一间空的农民房，需要买一台热水器，到了国美，海尔的推销员向我推荐了一款蓝火苗平衡式恒温热水器，号称平衡式设计采用全封闭结构，让热水器与室内完全隔离，保障家人安全，同时气压和水压变化时能自动调节水温，畅享整个沐浴过程！考虑到出租屋水压不稳，用的又是煤气罐，有了这个就不用担心传统热水器打不燃火的问题了，于是就买了。

装好后，老婆调皮地说了一句“洗上热水澡不再是梦”，可是万万没想到，这才是我们梦的开始。

热水器没用两天就老是熄火，找来售后服务人员，检查机器和安装都没有问题，给我的解释是可能是水压和气压不稳导致，我们说我的煤气罐是刚换的，他就说那就是水压问题。连续几次没有解决，我们就想或许真是出租屋水压低导致的，我们又住顶楼，就更有可能了。由于年底我们就要搬进新家，应该到时候就解决了。虽然偶尔会熄火，但是重新打又可以燃，对洗澡也没有太大的影响，忍一忍就过去了。

然而，搬新家后，问题依旧，而且更加睡频繁，有时候洗一次澡需要重新打好几次火，需要专门有人给看着。这时候，我们又请来了客服，但是客服来的时候它又不出问题，客服给我们的解释是，我们楼层高（27楼），可能还是水压不稳或者风太大，导致废气没正常排出去。按他这么说，我们楼高水压低，风也大，是环境客观问题，即使换热水器也还是这个问题。如此几次，还是没有解决。

直到保修期过了，问题还是依旧，最终我们决定换一台别的厂家的热水器。但是在换之前我向老婆申请让我来修一次，之前她总是出于安全考虑没让我动，但是这次破罐破摔，我终于有机会验证一下我的设想。

由每次熄火都是显示E2，根据海尔的手册，这是氧气不足，如果从排气管排出的废气，又被进气管吸入，肯定会产生这个问题。

于平衡式热水器的排气和进气管是一根嵌套在一起的双层管，其设计如下：
![平衡式排烟管设计](/img/yanguan.jpg "纸平衡式排烟管设")

排气管和进气管挨得很近，很容易产生下面的现象：
![废气吸入](/img/feiqi.jpg "废气吸入")

所以我要解决的问题就是把这两个隔离开，经过考虑，我决定放弃平衡式，从室内进气，这样就能防止废气被吸入。

最终的解决方案其实非常简单，就是把中间的一根弯管的外管去掉，只保留内管，最终效果如下：
![去掉外管](/img/diyYanGuan.JPG "去掉外管")

经过一段时间的试用，问题基本上解决，洗澡再也不用专人看火了，我和老婆又想起了那句话：“洗上热水澡不再是梦”！

这个案例历经几年时间，终于定位并解决，其实并不是海尔的热水器有多大的问题，而是出在小小的排气管设计上。我的方案虽然解决了问题，但是却丢掉了该产品平衡式设计的特性，只是临时方案，对于海尔本身来说，则应该从根本上解决排烟管的设计，防止废气进入进气管。

###安全二：iPad响应不了触摸事件###
最近开发的一个iPad软件，偶尔会发生触摸不能响应的Bug，但是发生的机率没有规律，困扰了我们很长一段时间。后来我们通过一周时间的不断尝试，终于复现了此Bug。

####Bug背景####
我们的app使用的是[myLauncher](https://github.com/jarada/myLauncher)框架，点击其中的图标会加载子模块。我们在这个框架上附加了一个可以下拉的View，用于显示额外的信息，其在Portrait和Landscape模式会分别加载了一张背景图片。

####Bug现象####
当问题出现时，上半屏的图标无法触摸（因为我们的图标较少，都在上半屏，所以起初以为都无法点击，但是由于我们一般是通过触摸下半屏进行滑动，所以我们以为可以滑动，实际上如果我们触摸上半屏也是不能滑动的）。

####Bug复现####
在Portrait模式启动程序后，旋转到Landscape模式，下拉附加的View，然后再旋转回Portrait模式，关闭下拉View，这时候上半屏不能响应触摸。

####Bug定位####
很明显，Bug与下拉View有关。我怀疑是此View遮挡了下面的View，导致触摸无法响应。为了验证此猜测，我将此View的backgroundColor设计为红色，然后用上面的复现步骤进行复现，果不其然，旋转回Portrait模式并关闭下拉View后，屏幕上仍然有一个红色的视图。

我想应该是视图的尺寸被自动调整了，使用下面的代码，关闭自动调整：

```
self.view.autoresizingMask = UIViewAutoresizingNone;
```

果然问题解决，只是关闭自动调整尺寸后，视图变得不正常，需要自己进行额外的处理。有没有更好的办法呢？

其实只需要在旋转时更新一下下拉View的frame:

```
- (void)willAnimateRotationToInterfaceOrientation:(UIInterfaceOrientation)toInterfaceOrientation duration:(NSTimeInterval)duration
{
    [super willAnimateRotationToInterfaceOrientation:toInterfaceOrientation duration:duration];
    [self updateDropdownViewFrame];
}
```
这个Bug主要难在问题很难复现，而且一开始发现的现象很片面，本身是上半屏被下拉View遮挡了，而下半屏是可以正常响应的，我们却把这个现象总结成了“可以滑动，不可以点击”。所以定位问题时，切忌以偏概全，对于所下结论要予以验证。

###总结###
以上两个Bug，是一名程序员在生活和工作中遇到，并花了很长时间去定位，但是却在定位之后很快解决的两个典型Bug。可以看到，解决这些Bug所花的时间主要是定位问题这部分，在定位问题的过程中也走了不少弯路，如果能提高自己分析定位Bug的能力，这类问题将会很快被解决。如何才能提高分析定位Bug的能力呢？我想只有不断的实践，并且学习别人的经验，掌握一定的思路，方能有所成就。
